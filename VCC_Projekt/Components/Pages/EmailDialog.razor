@using System.Net.Mail
@using Microsoft.AspNetCore.Components.Forms
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject EmailSender emailSender
@using MudExRichTextEditor
@using MudExRichTextEditor.Types

<MudDialog @bind-Visible="Visible">
    <DialogContent>
        <MudText Typo="Typo.h6">E-Mail senden</MudText>
        @if (UseDropdown)
        {
            <MudSelect T="string" SelectedValues="@SelectedEmails" SelectAll="Multiselect" SelectAllText="Alle auswählen" Label="An" MultiSelection="Multiselect" Required="true" SelectedValuesChanged="async e => await ValuesChanged(e)" Disabled="ReadOnly">
                @foreach (var email in Emails)
                {
                    <MudSelectItem Value="@email">@email</MudSelectItem>
                }
            </MudSelect>
        }
        else
        {
            <MudTextField @bind-Value="FixedEmail" ReadOnly="ReadOnly" Label="E-Mail-Adresse" Required="true" />
        }
        <MudTextField @bind-Value="EmailSubject" Label="Betreff" Required="true" />
        <MudExRichTextEdit Height="444" @ref="richTextEditor" Class="m-2" Placeholder="Nachricht bearbeiten" EnableResize="true" Tools="@(QuillTool.All().Where(q => q.Class != "" && q.Class != "ql-video").ToArray())" Immediate="false" Required="true" />
        <MudFileUpload T="IReadOnlyList<IBrowserFile>" FilesChanged="UploadFiles">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
                    Anhänge hinzufügen
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>
        <MudList T="IBrowserFile">
            @foreach (var file in Attachments)
            {
                <MudListItem Icon="@Icons.Material.Filled.AttachFile" OnClick="@(() => RemoveAttachment(file))">
                    @file.Name <code>@file.Size bytes</code>
                </MudListItem>
            }
        </MudList>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="StartSendingEmails" Disabled="@string.IsNullOrEmpty(EmailSubject)">Senden</MudButton>
        <MudButton Color="Color.Secondary" OnClick="Cancel">Abbrechen</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public List<string> SelectedEmails { get; set; } = new List<string>();
    [Parameter] public List<string> Emails { get; set; } = new List<string>();
    [Parameter] public bool Multiselect { get; set; } = true;
    [Parameter] public bool UseDropdown { get; set; } = true;
    [Parameter] public string FixedEmail { get; set; }
    [Parameter] public bool ReadOnly { get; set; } = false;

    private string EmailSubject;
    private MudExRichTextEdit richTextEditor;
    private List<IBrowserFile> Attachments = new List<IBrowserFile>();
    private const long maxAllowedSize = 20 * 1024 * 1024; // 20 MB

    private async Task StartSendingEmails()
    {
        List<Attachment> att = await ConvertToAttachmentsAsync(Attachments);
        Attachments.Clear();

        // Speichere die aktuellen E-Mails in einer temporären Variablen
        var tempSelectedEmails = new List<string>(SelectedEmails);
        var tempFixedEmail = FixedEmail;

        Visible = false;
        await VisibleChanged.InvokeAsync(Visible);
        Snackbar.Add("Emails werden geschickt...", Severity.Info);

        if (UseDropdown)
        {
            await emailSender.SendBulkEmailsAsync(tempSelectedEmails, EmailSubject, await richTextEditor.GetHtml(), att);
        }
        else
        {
            var message = new MailMessage
                {
                    Subject = EmailSubject,
                    Body = await richTextEditor.GetHtml(),
                    IsBodyHtml = true
                };
            message.To.Add(tempFixedEmail);
            foreach (var attachment in att)
            {
                message.Attachments.Add(attachment);
            }
            await emailSender.SendEmailAsync(message);
        }

        Snackbar.Clear();
        Snackbar.Add("Emails wurden geschickt!", Severity.Success);
    }

    private async Task ValuesChanged(IEnumerable<string> newValues)
    {
        SelectedEmails = newValues.ToList();
        await Task.CompletedTask;
    }

    private void Cancel()
    {
        Visible = false;
        VisibleChanged.InvokeAsync(Visible);
    }

    private void UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (file.Size > maxAllowedSize)
            {
                Snackbar.Add($"Datei {file.Name} ist zu groß (max. 20 MB erlaubt).", Severity.Error);
            }
            else
            {
                Attachments.Add(file);
            }
        }
    }

    private void RemoveAttachment(IBrowserFile file)
    {
        Attachments.Remove(file);
    }

    private async Task<List<Attachment>> ConvertToAttachmentsAsync(List<IBrowserFile> browserFiles)
    {
        var attachments = new List<Attachment>();

        foreach (var browserFile in browserFiles)
        {
            var stream = new MemoryStream();
            await browserFile.OpenReadStream(maxAllowedSize).CopyToAsync(stream);
            stream.Position = 0; // Reset stream position
            var attachment = new Attachment(stream, browserFile.Name);
            attachments.Add(attachment);
        }

        return attachments;
    }
}